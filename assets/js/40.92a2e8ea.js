(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{606:function(t,a,s){"use strict";s.r(a);var e=s(6),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"限流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限流"}},[t._v("#")]),t._v(" 限流")]),t._v(" "),s("p",[t._v("关于 Sentinel 限流功能，请点 "),s("RouterLink",{attrs:{to:"/docs/sentinel.html"}},[t._v("这里")]),t._v(" 查看。")],1),t._v(" "),s("h2",{attrs:{id:"目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#目录"}},[t._v("#")]),t._v(" 目录")]),t._v(" "),s("ul",[s("li",[t._v("限流的场景")]),t._v(" "),s("li",[t._v("限流的类型")]),t._v(" "),s("li",[t._v("限流的使用")]),t._v(" "),s("li",[t._v("限流的实现")])]),t._v(" "),s("h2",{attrs:{id:"限流的场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限流的场景"}},[t._v("#")]),t._v(" 限流的场景")]),t._v(" "),s("p",[t._v("在应用的开发中，我们经常会遇到这样的一些场景，例如：")]),t._v(" "),s("ul",[s("li",[t._v("秒杀")]),t._v(" "),s("li",[t._v("抢红包")])]),t._v(" "),s("p",[t._v("等等情况，这些业务都有一个明显的特征：并发量非常高。倘若没做好限流，往往会造成系统崩溃的情况。")]),t._v(" "),s("h2",{attrs:{id:"限流的类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限流的类型"}},[t._v("#")]),t._v(" 限流的类型")]),t._v(" "),s("p",[t._v("在 Jboot 中，我们可以对某个url请求进行限流，也可以对某个"),s("code",[t._v("java方法")]),t._v("进行限流。")]),t._v(" "),s("p",[t._v("Jboot 提供了两种方案：")]),t._v(" "),s("ul",[s("li",[t._v("TOKEN BUCKET ： 令牌桶，它可以配置1秒钟内，允许执行（或请求）多少次。")]),t._v(" "),s("li",[t._v("CONCURRENCY ： 并发量，可以配置为某个url地址或者某个方法名的并发量支持多少。")])]),t._v(" "),s("h2",{attrs:{id:"限流的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限流的使用"}},[t._v("#")]),t._v(" 限流的使用")]),t._v(" "),s("p",[s("strong",[t._v("使用方案1：通过配置来实现")])]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("jboot.properties")]),t._v(" 文件中定义如下：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("jboot.limit.enable = true\njboot.limit.rule = /user*:tb:1,/other*:iptb:1,io.jboot.aop*.get*(*):tb:1\njboot.limit.ipWhitelist = 127.0.0.1\n")])])]),s("ul",[s("li",[t._v("jboot.limit.enable : 限流功能的开关")]),t._v(" "),s("li",[t._v("jboot.limit.rule : 限流规则")]),t._v(" "),s("li",[t._v("jboot.limit.ipWhitelist : IP 白名单，多个 IP 用英文逗号隔开，此 IP 下的访问，将不受限流配置的影响")])]),t._v(" "),s("blockquote",[s("p",[t._v("规则说明：")]),t._v(" "),s("ul",[s("li",[t._v("1、可以配置多个规则，每个规则用英文逗号隔开")]),t._v(" "),s("li",[t._v("2、规则分为三个部分，用冒号（:）隔开，分别是：资源、限流类型、限流参数值")]),t._v(" "),s("li",[t._v("3、限流的类型有4种、分别是：tb、cc、iptb 和 ipcc。tb：TOKEN BUCKET（令牌桶，每秒允许访问的数量），cc：CONCURRENCY（并发量），iptb:单个ip每秒允许访问的数量，ipcc:单个ip允许同时的并发量。")]),t._v(" "),s("li",[t._v("4、星号（*）匹配任意字符，也可以是空字符。")])])]),t._v(" "),s("p",[t._v("在以上配置中，配置了三个规则，分别是：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("/user*:tb:1")])]),t._v(" "),s("li",[s("code",[t._v("/other*:iptb:1")])]),t._v(" "),s("li",[s("code",[t._v("io.jboot.aop*.get*(*):cc:1")])])]),t._v(" "),s("p",[t._v("第一个规则：匹配 "),s("code",[t._v("/user")]),t._v(" 开头的所有url地址，每个 url 地址，1 秒钟之内只允许访问 1 次。\n第二个规则：匹配 "),s("code",[t._v("/other")]),t._v(" 开头的所有url地址，每个 ip 地址在 1 秒钟之内只允许访问 1 次。\n第三个规则：匹配 "),s("code",[t._v("io.jboot.aop")]),t._v(" 开头的所有包名，并且 "),s("code",[t._v("get")]),t._v(" 开头的所有任意参数的方法。并发量为 1。")]),t._v(" "),s("p",[s("strong",[t._v("使用方案2：通过注解 "),s("code",[t._v("@EnableLimit")])])]),t._v(" "),s("p",[t._v("例如：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequestMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IndexController")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JbootController")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@EnableLimit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("fallback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fallbackMethod"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("index")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("renderText")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"index...."')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fallbackMethod")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("renderText")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fallback..."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("通过使用 "),s("code",[t._v('@EnableLimit(rate = 1,fallback = "fallbackMethod")')]),t._v(" 在方法 "),s("code",[t._v("index()")]),t._v(" 方法配置后，当用户访问："),s("code",[t._v("http://127.0.0.1:8080")]),t._v("时，1秒钟内只有一次访问到 "),s("code",[t._v("index()")]),t._v(" 方法，若有多次访问后，自动调用降级放方法 "),s("code",[t._v("fallbackMethod()")]),t._v(" 执行。")]),t._v(" "),s("p",[s("code",[t._v("@EnableLimit")]),t._v(" 支持的配置如下：")]),t._v(" "),s("ul",[s("li",[t._v("resource ： 资源名称（不配置的时候默认为方法名，Controller 默认为对应的 url 映射）")]),t._v(" "),s("li",[t._v("type：限流的类型，默认为令牌桶。")]),t._v(" "),s("li",[t._v("rate：限流的数值，必须配置")]),t._v(" "),s("li",[t._v("fallback：降级方法，若配置，此方法必须在当前的类下定义。")])]),t._v(" "),s("h2",{attrs:{id:"限流的实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限流的实现"}},[t._v("#")]),t._v(" 限流的实现")]),t._v(" "),s("p",[t._v("上文中提到，Jboot 提供了两种限流类型，他们分别是：")]),t._v(" "),s("ul",[s("li",[t._v("TOKEN BUCKET ： 令牌桶，每秒允许访问的次数。")]),t._v(" "),s("li",[t._v("CONCURRENCY ： 并发量，和时间无关。")])]),t._v(" "),s("p",[t._v("TOKEN BUCKET 令牌桶，是通过 Google Guava 的 RateLimiter 来实现的。")]),t._v(" "),s("p",[t._v("CONCURRENCY 并发量，是通过 "),s("code",[t._v("Semaphore")]),t._v(" 实现的，具体代码实现请查看 LimiterInterceptor 。")])])}),[],!1,null,null,null);a.default=n.exports}}]);